# Copilot / Agent guidance for stack2 üéÆ

## Quick summary ‚ú®
- Cocos Creator 3.x TypeScript game targeted at **WeChat Mini Game** (see `project.config.json`, Creator version 3.8.6 in `package.json`).
- Frontend is a single-scene game (assets under `assets/`), backend is lightweight WeChat Cloud Functions (`cloudfunctions/`).

## Where to look üîé (key files & folders)
- Game logic and UI: `assets/scripts/StackGame.ts`, `FriendRankView.ts`, `CloudService.ts`.
- Prefabs & assets: `assets/prefab/BlockPrefab.prefab`, `assets/sound/` (audio naming pattern: `2stack_success_cute.wav` ‚Ä¶).
- Cloud functions (leaderboard): `cloudfunctions/getLeaderboard/index.js`, `cloudfunctions/submitScore/index.js`.
- Build/targets: `project.config.json` -> `miniprogramRoot` (e.g., `build/wechatgame-002/`), generated build output under `build/wechatgame/`.

## Big-picture architecture üèóÔ∏è
- Single-page Cocos Creator app that runs inside WeChat Mini Game. 
- Social features use WeChat Open Data Context: `FriendRankView` uses `SubContextView` + `wx.getOpenDataContext()` and posts messages to the subdomain.
- Persistent leaderboard is implemented via WeChat Cloud Functions and a `leaderboard` DB collection; `CloudService.ts` calls `getLeaderboard` and `submitScore`.

## Important integration points & invariants üîó
- Guard all calls to WeChat APIs with `if (typeof wx !== 'undefined')` (existing pattern used widely). See `CloudService.ts` and `FriendRankView.ts`.
- Cloud environment is hard-coded in `CloudService.ts` as `CLOUD_ENV_ID = 'stack-8gh0yv7b83251f56'`. Update that if deploying to another cloud env.
- `submitScore` stores data using `OPENID` as document id (see `cloudfunctions/submitScore/index.js`).
- `FriendRankView.show()` expects/creates `Canvas/FriendRankRoot` node and configures `SubContextView.designResolutionSize` ‚Äî be careful changing node names or anchors.

## Developer workflows & notes ‚öôÔ∏è
- Build & preview: open the project in **Cocos Creator 3.8.x** and use the **Build** ‚Üí target **WeChat Game** (output folder is `build/wechatgame-*/`). Then open that output in **WeChat DevTools** using `project.config.json` in the build folder.
- Cloud functions: code is in `cloudfunctions/` and can be deployed via WeChat Cloud Console or the WeChat DevTools when using the built mini program project.
- No test framework found; rely on editor preview + WeChat DevTools for runtime checks.

## Project-specific conventions & patterns ‚úÖ
- Language: TypeScript with Cocos 3.x API surface; comments and inline docs are often in **Chinese**.
- Defensive programming: functions use `try/catch` and runtime guards (e.g., `if (!wx || !wx.cloud) return`), and provide editor-friendly mocks such as `mockReviveInEditor` in `StackGame.ts`.
- UI conventions: nodes like `Canvas/FriendRankRoot` and close button nodes are created programmatically ‚Äî keep naming consistent if you add references elsewhere.
- Audio handling: BGM starts only after first user gesture (see `_bindUserGestureForBGM()` in `StackGame.ts`) to avoid browser autoplay restrictions.
- Resource pool: simple pooling is implemented for blocks/effects (`_pool` in `StackGame.ts`) ‚Äî prefer reusing these utilities rather than re-instantiating frequently.

## Safe edit & deployment notes ‚ö†Ô∏è
- Do NOT edit `build/` outputs directly ‚Äî they are generated by Cocos Creator.
- To change cloud env or keys: edit `CloudService.ts` and then redeploy `cloudfunctions/` to the correct cloud environment.
- SharedCanvas size: `FriendRankView._clampSize()` enforces even numbers and max texture size ‚Äî changing this needs careful testing on low-capability devices.

## Examples (where to make small changes)
- Change leaderboard fetch size constraint: `cloudfunctions/getLeaderboard/index.js` (limit clamped 1..50).
- Change share text: `StackGame.shareTitle` in `assets/scripts/StackGame.ts`.
- Change revive debug behavior: `mockReviveInEditor` property on `StackGame.ts`.

## Missing/observations and suggestions üí°
- No automated test suite or CI configuration detected ‚Äî adding a smoke test (e.g., linter + minimal runtime smoke run) would reduce regressions.
- Consider adding a short README or CONTRIBUTING with exact Cocos Creator version and a reproducible build+deploy checklist (the core pieces are in `project.config.json` and `package.json`).

---
If anything above is unclear or you'd like more examples (e.g., specific code snippets to modify a behavior), tell me which area to expand and I‚Äôll update this file. ‚úÖ
